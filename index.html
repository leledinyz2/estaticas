<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ðŸŽµ Placar Just Dance do Lele ðŸŽµ</title>
<style>
  body { font-family: "Poppins", sans-serif; background:#0d0d0d; color:#f4f4f4; margin:0 }
  header { background:#b30a3c; text-align:center; padding:20px; font-size:1.6rem; font-weight:600; color:#fff; border-radius:0 0 10px 10px; }
  .container { max-width:980px; margin:30px auto; padding:20px; background:#111; border-radius:10px; box-shadow:0 4px 20px rgba(255,255,255,0.04); overflow-x:auto; }
  .controls { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:8px; align-items:center; }
  label { font-size:0.9rem; color:#ddd }
  select,input { padding:8px 10px; border-radius:6px; border:1px solid #333; background:#161616; color:#fff }
  table { width:100%; border-collapse:collapse; margin-top:12px; table-layout:fixed; word-wrap:break-word; }
  th,td { padding:10px; border-bottom:1px solid #222; text-align:left; vertical-align:middle }
  th { color:#ff88b3; font-weight:600 }
  tr:hover { background:#1a1a1a }
  footer { text-align:center; color:#999; margin-top:16px; font-size:0.9rem }
  .small { font-size:0.85rem; color:#aaa; margin-left:8px }
</style>
</head>
<body>
<header>ðŸŽµ Placar Just Dance do Lele ðŸŽµ</header>

<div class="container">
  <div class="controls">
    <div>
      <label>Filtro por estrelas mÃ­nimas:</label><br>
      <select id="filtroEstrelas"><option value="0">Todas</option><option value="1">1+</option><option value="2">2+</option><option value="3">3+</option><option value="4">4+</option><option value="5">5</option></select>
    </div>
    <div style="flex:1">
      <label>Buscar mÃºsica:</label><br>
      <input id="buscaMusica" type="text" placeholder="Digite o nome..." style="width:100%"/>
    </div>
  </div>

  <div class="small" id="detectedHeaders"></div>

  <table id="tabela" aria-live="polite">
    <thead>
      <tr>
        <th>MÃºsica</th>
        <th>VersÃ£o</th>
        <th>PontuaÃ§Ã£o</th>
        <th>Estrelas</th>
        <th>Jogo</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <footer>Atualiza automaticamente com base na planilha do Lele ðŸ’ƒ</footer>
</div>

<script>
/* URL pÃºblica do CSV (o seu link no formato /pub?output=csv) */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTas34kcpM1cQdW2oR_XjNlINTVShbwfTyVdYnBe2glvdvlJbcDlbQ0npgTdJZ_6p-tQgozmHmnsCQy/pub?gid=0&single=true&output=csv";

/* --- Parser CSV robusto (suporta aspas, vÃ­rgulas internas e quebras de linha dentro de campos) --- */
function parseCSV(text) {
  const rows = [];
  let i = 0, cur = '', row = [], inQuotes = false;
  while (i < text.length) {
    const ch = text[i];
    if (inQuotes) {
      if (ch === '"') {
        if (text[i+1] === '"') { cur += '"'; i += 2; continue; } // escaped quote
        inQuotes = false; i++; continue;
      } else {
        cur += ch; i++; continue;
      }
    } else {
      if (ch === '"') { inQuotes = true; i++; continue; }
      if (ch === ',') { row.push(cur); cur = ''; i++; continue; }
      if (ch === '\r') { i++; continue; }
      if (ch === '\n') { row.push(cur); rows.push(row); row = []; cur = ''; i++; continue; }
      cur += ch; i++;
    }
  }
  // push last
  if (cur !== '' || row.length) row.push(cur);
  if (row.length) rows.push(row);
  return rows;
}

/* --- Carrega CSV e transforma em array de objetos com cabeÃ§alho --- */
async function carregarDados() {
  const res = await fetch(CSV_URL);
  if (!res.ok) throw new Error('Erro ao baixar CSV: ' + res.status);
  const text = await res.text();
  const parsed = parseCSV(text);
  if (!parsed.length) return [];
  const headers = parsed[0].map(h => (h||'').trim());
  // monta objetos: limpa quebras internas e espaÃ§os extras
  const dados = parsed.slice(1).map(r => {
    const obj = {};
    for (let i = 0; i < headers.length; i++) {
      const raw = r[i] === undefined ? '' : r[i];
      // remove quebras de linha internas e aspas residuais, e trim
      obj[headers[i]] = String(raw).replace(/[\r\n]+/g, ' ').replace(/['"]+/g,'').trim();
    }
    return obj;
  });
  return { headers, dados };
}

/* --- Encontrar colunas de interesse (case-insensitive) --- */
function detectColumns(headers) {
  const low = headers.map(h => h.toLowerCase());
  const find = (cands) => {
    for (const c of cands) {
      const idx = low.findIndex(h => h.includes(c));
      if (idx !== -1) return headers[idx];
    }
    return null;
  };
  return {
    musica: find(['mÃºsica','musica','song','music']) || headers[0],
    versao: find(['versÃ£o','versao','version','vers']) || headers[1] || headers[0],
    pontuacao: find(['pontuaÃ§Ã£o','pontuacao','pontu','score','pont']) || headers[2] || headers[0],
    estrelas: find(['estrela','estrelas','stars']) || null,
    jogo: find(['jogo','game','plataforma']) || headers[headers.length-1]
  };
}

/* --- Render tabela --- */
function exibirTabela(dados, cols) {
  const tbody = document.querySelector('#tabela tbody');
  tbody.innerHTML = '';
  dados.forEach(d => {
    const musica = d[cols.musica] || '';
    const versao = d[cols.versao] || '';
    const pontuacao = d[cols.pontuacao] || '';
    let estrelasRaw = cols.estrelas ? (d[cols.estrelas] || '') : '';
    // tenta extrair nÃºmero de estrelas - se for grande (ex: pontuaÃ§Ã£o), nÃ£o exagerar: se >10, tratamos como 0
    let eNum = parseInt((estrelasRaw || '').replace(/[^\d\-]/g,''), 10);
    if (isNaN(eNum)) eNum = 0;
    if (eNum > 10) eNum = Math.min(5, Math.round(eNum/1000)) || 0; // heurÃ­stica: valores muito grandes provavelmente nÃ£o sÃ£o "estrelas"
    eNum = Math.max(0, Math.min(5, eNum));
    const estrelasHTML = 'ðŸ’›'.repeat(eNum);
    const jogo = d[cols.jogo] || '';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(musica)}</td>
                    <td>${escapeHtml(versao)}</td>
                    <td>${escapeHtml(pontuacao)}</td>
                    <td>${estrelasHTML}</td>
                    <td>${escapeHtml(jogo)}</td>`;
    tbody.appendChild(tr);
  });
}

/* --- filtros --- */
function aplicarFiltros() {
  const minE = parseInt(document.getElementById('filtroEstrelas').value, 10);
  const q = document.getElementById('buscaMusica').value.toLowerCase();
  const filtered = ALL_DATA.filter(d => {
    const estrelasRaw = cols.estrelas ? (d[cols.estrelas] || '') : '';
    let eNum = parseInt((estrelasRaw || '').replace(/[^\d\-]/g,''), 10);
    if (isNaN(eNum)) eNum = 0;
    if (eNum > 10) eNum = Math.min(5, Math.round(eNum/1000)) || 0;
    eNum = Math.max(0, Math.min(5, eNum));
    const nome = ((d[cols.musica]||'') + '').toLowerCase();
    return eNum >= minE && nome.includes(q);
  });
  exibirTabela(filtered, cols);
}

/* --- util --- */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* --- bootstrap --- */
let ALL_DATA = [];
let cols = null;
(async function init(){
  try {
    const result = await carregarDados();
    const headers = result.headers;
    const dados = result.dados;
    ALL_DATA = dados;
    cols = detectColumns(headers);
    document.getElementById('detectedHeaders').textContent = 'Colunas detectadas: ' + headers.join(' â€¢ ');
    exibirTabela(ALL_DATA, cols);
  } catch(err) {
    document.getElementById('detectedHeaders').textContent = 'Erro ao carregar CSV: ' + err.message;
    console.error(err);
  }
})();

document.getElementById('filtroEstrelas').addEventListener('change', aplicarFiltros);
document.getElementById('buscaMusica').addEventListener('input', aplicarFiltros);
</script>
</body>
</html>
